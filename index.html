
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>프리미엄 가계부</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="container">
    <div class="left">
        <h2><i class="fas fa-wallet"></i> 가계부 입력</h2>
        
        <div class="input-section">
            <label for="date"><i class="fas fa-calendar-alt"></i> 날짜</label>
            <input type="date" id="date">
        </div>

        <div class="input-section">
            <h3><i class="fas fa-arrow-down"></i> 수입</h3>
            <label for="income-amount">금액</label>
            <input type="number" id="income-amount" placeholder="수입 금액 입력...">
            <button class="income-btn" onclick="addTransaction('income')"><i class="fas fa-plus-circle"></i> 수입 추가</button>
        </div>

        <div class="input-section">
            <h3><i class="fas fa-arrow-up"></i> 지출</h3>
            <label for="expense-amount">금액</label>
            <input type="number" id="expense-amount" placeholder="지출 금액 입력...">
            <button class="expense-btn" onclick="addTransaction('expense')"><i class="fas fa-minus-circle"></i> 지출 추가</button>
        </div>
    </div>

    <div class="right">
        <h2><i class="fas fa-chart-line"></i> 월별 요약</h2>
        <div id="monthList"></div>
    </div>
</div>

<!-- 상세내역 모달 -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
    const dateInput = document.getElementById('date');
    const incomeAmountInput = document.getElementById('income-amount');
    const expenseAmountInput = document.getElementById('expense-amount');

    let data = JSON.parse(localStorage.getItem("household_premium")) || [];

    function setDateToToday() {
        const now = new Date();
        dateInput.value = now.toISOString().substring(0, 10);
    }

    setDateToToday();
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') setDateToToday();
    });

    incomeAmountInput.addEventListener('keydown', e => e.key === 'Enter' && addTransaction('income'));
    expenseAmountInput.addEventListener('keydown', e => e.key === 'Enter' && addTransaction('expense'));

    function addTransaction(type) {
        const date = dateInput.value;
        const amount = parseInt((type === 'income' ? incomeAmountInput : expenseAmountInput).value) || 0;

        if (!date) { alert("날짜를 선택하세요."); return; }
        if (amount <= 0) { alert("금액은 0보다 커야 합니다."); return; }

        data.push({ id: Date.now(), date, type, amount });
        localStorage.setItem("household_premium", JSON.stringify(data));

        const amountInput = type === 'income' ? incomeAmountInput : expenseAmountInput;
        amountInput.value = "";
        amountInput.focus();

        render();
    }

    function deleteData(id, date, type, month) {
        if(!confirm("이 항목을 삭제하시겠습니까?")) return;
        data = data.filter(item => item.id !== id);
        localStorage.setItem("household_premium", JSON.stringify(data));
        render();
        showTransactionDetails(date, type, month);
    }

    function deleteAllTransactions(date, type, month) {
        const typeText = type === 'income' ? '수입' : '지출';
        if (!confirm(`${date}의 모든 ${typeText} 내역을 삭제하시겠습니까?`)) return;
        data = data.filter(item => !(item.date === date && item.type === type));
        localStorage.setItem("household_premium", JSON.stringify(data));
        render();
        showDetails(month);
    }

    function deleteMonthlyData(month, type) {
        const typeText = type === 'income' ? '수입' : '지출';
        if (!confirm(`${month + 1}월의 모든 ${typeText} 내역을 삭제하시겠습니까?`)) return;
        data = data.filter(item => !(new Date(item.date).getMonth() === month && item.type === type));
        localStorage.setItem("household_premium", JSON.stringify(data));
        render();
        showDetails(month);
    }

    function render() {
        let monthlySummaries = Array(12).fill(null).map(() => ({ income: 0, expense: 0 }));
        let totalIncome = 0;
        let totalExpense = 0;

        data.forEach(item => {
            const month = new Date(item.date).getMonth();
            monthlySummaries[month][item.type] += item.amount;
        });

        let html = "";
        for (let i = 0; i < 12; i++) {
            const summary = monthlySummaries[i];
            const total = summary.income - summary.expense;
            totalIncome += summary.income;
            totalExpense += summary.expense;
            const totalColor = total < 0 ? 'var(--danger-color)' : 'var(--text-color)';

            html += `<div class="month" onclick="showDetails(${i})">
                        <span>${i + 1}월</span>
                        <span class="income-text">+${summary.income.toLocaleString()}</span>
                        <span class="expense-text">-${summary.expense.toLocaleString()}</span>
                        <span class="total-text" style="color:${totalColor};">${total.toLocaleString()} 원</span>
                     </div>`;
        }

        const grandTotal = totalIncome - totalExpense;
        const grandTotalColor = grandTotal < 0 ? 'var(--danger-color)' : 'var(--text-color)';
        html += `<div class="yearly-total">
                     <span><i class="fas fa-globe-asia"></i> 총계</span>
                     <span class="income-text">+${totalIncome.toLocaleString()}</span>
                     <span class="expense-text">-${totalExpense.toLocaleString()}</span>
                     <span class="total-text" style="color:${grandTotalColor};">${grandTotal.toLocaleString()} 원</span>
                  </div>`;

        document.getElementById("monthList").innerHTML = html;
    }

    function showDetails(month) {
        const monthData = data.filter(item => new Date(item.date).getMonth() === month);
        const dailySummary = {};
        monthData.forEach(item => {
            if (!dailySummary[item.date]) {
                dailySummary[item.date] = { income: 0, expense: 0 };
            }
            dailySummary[item.date][item.type] += item.amount;
        });

        document.getElementById("modalTitle").innerHTML = `<i class="far fa-calendar-check"></i> ${month + 1}월 상세 내역`;

        let headerHtml = `<div class="modal-header-controls">`;
        if (monthData.some(i => i.type === 'income')) headerHtml += `<button class="btn income-btn" onclick="deleteMonthlyData(${month}, 'income')"><i class="fas fa-trash-alt"></i> 이 달의 모든 수입 삭제</button>`;
        if (monthData.some(i => i.type === 'expense')) headerHtml += `<button class="btn expense-btn" onclick="deleteMonthlyData(${month}, 'expense')"><i class="fas fa-trash-alt"></i> 이 달의 모든 지출 삭제</button>`;
        headerHtml += `</div>`;

        let bodyHtml = `<div class="detail-item detail-header">
                          <span>날짜</span><span>수입</span><span>지출</span><span style="text-align:right;">일일 합계</span>
                      </div>`;

        const sortedDates = Object.keys(dailySummary).sort();
        if (sortedDates.length === 0) {
            bodyHtml += "<p style='text-align:center; padding: 20px;'>해당 월의 데이터가 없습니다.</p>";
        } else {
            sortedDates.forEach(date => {
                const day = dailySummary[date];
                const total = day.income - day.expense;
                const totalColor = total < 0 ? 'var(--danger-color)' : 'var(--text-color)';
                bodyHtml += `<div class="detail-item">
                                <span>${date}</span>
                                <span class="income-text clickable-amount" onclick="showTransactionDetails('${date}', 'income', ${month})">${day.income.toLocaleString()}원</span>
                                <span class="expense-text clickable-amount" onclick="showTransactionDetails('${date}', 'expense', ${month})">${day.expense.toLocaleString()}원</span>
                                <span style="font-weight:bold; text-align:right; color:${totalColor};">${total.toLocaleString()}원</span>
                             </div>`;
            });
        }
        
        document.getElementById("modalBody").innerHTML = headerHtml + bodyHtml;
        document.getElementById("detailsModal").style.display = "block";
    }

    function showTransactionDetails(date, type, month) {
        const transactions = data.filter(item => item.date === date && item.type === type);
        const typeText = type === 'income' ? '수입' : '지출';
        const typeIcon = type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up';

        document.getElementById("modalTitle").innerHTML = `<i class="fas ${typeIcon}"></i> ${date} ${typeText} 내역`;

        let bodyHtml = `<div class="modal-header-controls">
                            <button class="btn back-btn" onclick="showDetails(${month})"><i class="fas fa-chevron-left"></i> 뒤로가기</button>
                            <button class="btn expense-btn" onclick="deleteAllTransactions('${date}', '${type}', ${month})"><i class="fas fa-dumpster-fire"></i> 전체 삭제</button>
                        </div>
                        <div class="detail-item detail-header">
                            <span>금액</span><span style="grid-column: 4 / 5; text-align:right;">삭제</span>
                        </div>`;

        if (transactions.length === 0) {
            bodyHtml += "<p style='text-align:center; padding: 20px;'>해당 내역이 없습니다.</p>";
        } else {
            transactions.forEach(item => {
                bodyHtml += `<div class="detail-item">
                                <span style="font-weight:bold; grid-column: 1 / 4;">${item.amount.toLocaleString()}원</span>
                                <button class="btn expense-btn" style="padding: 5px 10px; justify-self: end;" onclick="deleteData(${item.id}, '${date}', '${type}', ${month})"><i class="fas fa-trash"></i></button>
                             </div>`;
            });
        }

        document.getElementById("modalBody").innerHTML = bodyHtml;
    }
    
    function closeModal() {
        document.getElementById("detailsModal").style.display = "none";
    }
    
    window.onclick = function(event) {
        if (event.target == document.getElementById("detailsModal")) {
            closeModal();
        }
    }

    render();
</script>

</body>
</html>
